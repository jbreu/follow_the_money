<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IATI Activities</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css"
        integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        .world-map-container {
            max-width: 100%;
            margin-bottom: 2rem;
        }

        #map-container {
            height: 400px;
            width: 100%;
        }

        .country {
            fill: #e8e8e8;
            stroke: #fff;
            stroke-width: 0.5;
        }

        .country-highlighted {
            fill: #0d6efd;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <h1 class="text-primary mb-4">IATI Activities</h1>
        <h2 class="text-primary mb-4">German government spending to foreign organizations</h2>

        <div class="card mb-4">
            <div class="card-body">
                <form method="get" action="" class="row g-3">
                    <div class="col-md-4">
                        <label for="year" class="form-label">Year</label>
                        <select id="year" name="year" class="form-select">
                            <option value="">All Years</option>
                            {% for year in available_years %}
                            <option value="{{ year }}" {% if request.args.get('year')==year|string %}selected{% endif
                                %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="organization" class="form-label">Organization</label>
                        <select id="organization" name="organization" class="form-select">
                            <option value="">All Organizations</option>
                            {% for org in available_organizations %}
                            <option value="{{ org }}" {% if request.args.get('organization')==org %}selected{% endif %}>
                                {{ org }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="country" class="form-label">Recipient Country</label>
                        <select id="country" name="country" class="form-select">
                            <option value="">All Countries</option>
                            {% for country in available_countries %}
                            <option value="{{ country }}" {% if request.args.get('country')==country %}selected{% endif
                                %}>{{ country }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="min_value" class="form-label">Min Value (€)</label>
                        <input type="number" class="form-control" id="min_value" name="min_value"
                            value="{{ request.args.get('min_value', '') }}">
                    </div>

                    <div class="col-md-3">
                        <label for="max_value" class="form-label">Max Value (€)</label>
                        <input type="number" class="form-control" id="max_value" name="max_value"
                            value="{{ request.args.get('max_value', '') }}">
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title">Total Value for Current Filter</h4>
                <h2 class="text-success">{{ '{:,.2f}'.format(activities | sum(attribute='total_transaction_value')) }} €
                </h2>
            </div>
        </div>

        <!-- Add map container here -->
        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title">Recipient Countries</h4>
                <div class="world-map-container">
                    <div id="map-container"></div>
                </div>
            </div>
        </div>

        <div class="list-group">
            {% for activity in activities %}
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between mb-2">
                    <h5 class="mb-1">{{ activity.title }}</h5>
                    <span class="badge bg-primary">{{ '{:,.2f}'.format(activity.total_transaction_value) }} €</span>
                </div>
                <p class="mb-1">
                    <small class="text-muted">
                        Period: {{ activity.start_date }} to {{ activity.end_date }}<br>
                        Organization: {{ activity.reporting_org }}<br>
                        Countries: {% for country in activity.recipient_countries %}
                        <span class="flag-icon flag-icon-{{ country[:2].lower() }}"></span> {{ country }}{% if not
                        loop.last %}, {% endif %}
                        {% endfor %}
                    </small>
                </p>
                <details class="mt-2">
                    <summary class="btn btn-sm btn-outline-secondary">View Transactions</summary>
                    <div class="table-responsive mt-2">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Value (€)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in activity.transactions %}
                                <tr>
                                    <td>{{ transaction.type }}</td>
                                    <td>{{ transaction.date }}</td>
                                    <td>{{ transaction.value }} €</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </details>
            </div>
            {% endfor %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Get unique countries and their values
        const countries = [{% for activity in activities %}{% for country in activity.recipient_countries %} "{{ country[:2].lower() }}"{% if not loop.last %}, {% endif %} {% endfor %} {% if not loop.last %}, {% endif %} {% endfor %}].filter((v, i, a) => a.indexOf(v) === i);

        // Initialize the map
        const map = L.map('map-container').setView([20, 0], 2);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Load GeoJSON data
        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function (feature) {
                        const countryCode = feature.properties.iso_a2?.toLowerCase();
                        return {
                            fillColor: countries.includes(countryCode) ? '#0d6efd' : '#e8e8e8',
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindTooltip(feature.properties.name);
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error loading map data:', error));
    </script>
</body>

</html>