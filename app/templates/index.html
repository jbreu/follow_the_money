<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IATI Activities</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <h1>IATI Activities</h1>

    <form method="get" action="">
        <label for="year">Year:</label>
        <select id="year" name="year">
            <option value="">All Years</option>
            {% for year in available_years %}
            <option value="{{ year }}" {% if request.args.get('year')==year|string %}selected{% endif %}>{{ year }}
            </option>
            {% endfor %}
        </select>

        <label for="organization">Organization:</label>
        <select id="organization" name="organization">
            <option value="">All Organizations</option>
            {% for org in available_organizations %}
            <option value="{{ org }}" {% if request.args.get('organization')==org %}selected{% endif %}>{{ org }}
            </option>
            {% endfor %}
        </select>

        <label for="country">Recipient Country:</label>
        <select id="country" name="country">
            <option value="">All Countries</option>
            {% for country in available_countries %}
            <option value="{{ country }}" {% if request.args.get('country')==country %}selected{% endif %}>{{ country }}
            </option>
            {% endfor %}
        </select>

        <label for="min_value">Min Value:</label>
        <input type="number" id="min_value" name="min_value" value="{{ request.args.get('min_value', '') }}">

        <label for="max_value">Max Value:</label>
        <input type="number" id="max_value" name="max_value" value="{{ request.args.get('max_value', '') }}">

        <button type="submit">Filter</button>
    </form>

    <h2>Total Value for Current Filter:</h2>
    <p>{{ '{:,.2f}'.format(activities | sum(attribute='total_transaction_value')) }} €</p>

    <ul>
        {% for activity in activities %}
        <li>
            <strong>{{ activity.title }}</strong> - {{ activity.start_date }} to {{ activity.end_date }}<br>
            Total Transaction Value: {{ '{:,.2f}'.format(activity.total_transaction_value) }} €<br>
            Reporting Organization: {{ activity.reporting_org }}<br>
            Recipient Countries: {{ activity.recipient_countries | join(', ') }}
            <details>
                <summary>View Transactions</summary>
                <table>
                    <tr>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Value (€)</th>
                    </tr>
                    {% for transaction in activity.transactions %}
                    <tr>
                        <td>{{ transaction.type }}</td>
                        <td>{{ transaction.date }}</td>
                        <td>{{ transaction.value }} €</td>
                    </tr>
                    {% endfor %}
                </table>
            </details>
        </li>
        {% endfor %}
    </ul>
</body>

</html>